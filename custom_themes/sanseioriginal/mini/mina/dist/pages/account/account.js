(function(){var app,core,deco,restCustomer,restStore,utils;core=require('../../core.js');deco=require('../../decorators.js');utils=require('../../utils.js');restStore=require('../../restapi/store.js');restCustomer=require('../../restapi/customer.js');app=getApp();core.Page({data:{image:core.image,orders:[],is_empty:null,has_more:false},timestamp:null,onLoad:deco.login_required(function(opts){var self;self=this;app.set_tabs();app.set_navbar('$account',true);app.get_profile(function(profile){return self.setData({profile:profile});});return self.load();}),onPullDownRefresh:function(){var self;self=this;if(!self.data.loaded){return;}
return self.load().finally(function(){return wx.stopPullDownRefresh();});},onReachBottom:function(){var self;self=this;if(!self.data.loaded){return;}
if(self.data.has_more===true){return self.list();}},load:function(){var self;self=this;self.timestamp=utils.now();self.setData({loaded:false,orders:[],has_more:null});return self.list().finally(function(){return self.setData({loaded:true,is_empty:self.data.orders.length<=0});});},list:function(){var self;self=this;self.setData({is_loading:true});return restCustomer.order.list({offset:self.data.orders.length,t:self.timestamp}).then(function(results){var last_one,orders;orders=self.data.orders.concat(results);last_one=results[results.length-1]||{_more:false,_count:0};return self.setData({orders:orders,has_more:last_one._more});}).finally(function(){return self.setData({is_loading:false});});},open:function(e){var order,self;self=this;order=e.currentTarget.dataset.order;if(!order){return;}
return app.nav.go({route:core.config.paths.order,args:{id:order.id}});},go_buy:function(){return app.nav.tab({route:core.config.paths.index});},join_member:function(e){var encrypted_data,iv,self;self=this;encrypted_data=e.detail.encryptedData;iv=e.detail.iv;if(!encrypted_data||!iv){return;}
return wx.checkSession({success:function(){return self._join(encrypted_data,iv);},fail:function(){return app.login(function(){return self._join(encrypted_data,iv);},true);}});},_join:function(encrypted_data,iv){var self;self=this;return restCustomer.member.create({encrypted_data:encrypted_data,iv:iv}).then(function(profile){return app.set_profile(profile,function(profile){return self.setData({profile:profile});});});},sync_profile:function(e){var profile,self;self=this;profile=core.reform_userinfo(e.detail.userInfo);return app.set_profile(profile,function(profile){return self.setData({profile:profile});});}});}).call(this);