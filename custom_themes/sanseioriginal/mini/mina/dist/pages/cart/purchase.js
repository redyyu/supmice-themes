(function(){var app,core,deco,restCustomer,restStore,utils;core=require('../../core.js');utils=require('../../utils.js');deco=require('../../decorators.js');restStore=require('../../restapi/store.js');restCustomer=require('../../restapi/customer.js');app=getApp();core.Page({data:{image:core.image,total_price:0,payment:0,use_credit:false,spent_credit:0,exchange_payment:0,courier_fee:0,items:[],expired_items:[],is_empty:false,consignee:null},direct:null,note:'',submitted:false,onLoad:deco.login_required(function(opts){var self;self=this;app.set_navbar('$purchase',true);self.direct=opts.direct;self.check_address_authorization();return self.load();}),load:function(){var self;self=this;self.setData({loaded:false});return restCustomer.check_cart({items:app.checkout.list()}).then(function(cart){if(self.data.use_credit){cart.payment-=cart.exchange_payment;}
return self.setData({loaded:true,items:cart.items,is_empty:!cart.items.length,expired_items:cart.expired_items,courier_fee:cart.courier_fee,total_price:cart.total_price,total_vouchers:cart.total_vouchers,payment:cart.payment,spent_credit:cart.spent_credit,exchange_payment:cart.exchange_payment});});},get_shipping_address:function(){var self;self=this;self.check_address_authorization();return wx.chooseAddress({success:function(info){return self.setData({consignee:core.reform_consignee(info)});},fail:function(){return self.check_address_authorization();}});},check_address_authorization:function(){var self;self=this;return core.get_authorize('scope.address',function(status){if(status===void 0){status=true;}
return self.setData({address_authorized:status});});},input_note:function(e){var self;self=this;try{return self.note=e.detail.value||'';}catch(error){return self.note='';}},toggle_use_credit:function(){var payment,self,use_credit;self=this;payment=self.data.payment;use_credit=!self.data.use_credit;if(use_credit){payment-=self.data.exchange_payment;}else{payment+=self.data.exchange_payment;}
return self.setData({payment:payment||1,use_credit:use_credit});},go_back:function(){return app.nav.back();},purchase:function(e){var consignee,self;self=this;if(self.submitted){return;}
self.submitted=true;consignee=self.data.consignee;return restCustomer.purchase({name:consignee.name,recipient:consignee.recipient,note:self.note,items:self.data.items,use_credit:Boolean(self.data.use_credit)}).then(function(result){if(result.prepay_id){return self._make_order(result);}else{return core.toast({title:e.currentTarget.dataset.errorTitle,image:e.currentTarget.dataset.errorIcon},function(){return app.nav.back();});}});},_make_order:function(result){var self;self=this;return wx.requestPayment({timeStamp:result.timestamp,nonceStr:result.nonce_str,package:result.package,signType:result.sign_type,paySign:result.pay_sign,success:function(res){var i,item,len,ref;if(!self.direct){ref=self.data.items;for(i=0,len=ref.length;i<len;i++){item=ref[i];app.cart.remove(item.id);}}
app.checkout.clear();return self.setData({payment:result.payment,courier_fee:result.courier_fee,paid:true});},fail:function(res){restCustomer.order.cancel(result.id);if(res.err_code){console.error(res);self.setData({pay_error:true});}
if(res.err_desc){return wx.showToast({icon:'none',title:res.err_desc,mask:true,duration:2400});}},complete:function(){return self.submitted=false;}});}});}).call(this);