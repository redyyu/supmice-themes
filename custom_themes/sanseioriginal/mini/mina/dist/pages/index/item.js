(function(){var app,core,restStore,utils;core=require('../../core.js');utils=require('../../utils.js');restStore=require('../../restapi/store.js');app=getApp();core.Page({data:{meta:{},content:'',amount:1,shelf:null,sku_list:[],sel_sku:null,sheet_status:false,sku_status:null,image:core.image,action_type:null},slug:null,sel_attrs:{},onShareAppMessage:function(){var e,img_src,meta,self,share_obj;self=this;meta=self.data.meta;if(meta){try{img_src=meta.featured_img.src;}catch(error){e=error;img_src='';}
share_obj={title:meta.title,imageUrl:img_src,path:core.config.paths.item+'?slug='+meta.slug};}else{share_obj={};}
return app.share(share_obj);},onLoad:function(opts){var self;self=this;self.slug=opts.slug;return self.load();},onShow:function(){var self;self=this;return self.setData({count_cart_items:app.cart.list().length});},load:function(){var self;self=this;self.setData({loaded:false});return restStore.product.get(self.slug).then(function(product){app.set_navbar(product.meta.title);return self.setData({meta:product.meta,content:core.purify_content_img(product.content)});}).then(function(){return restStore.product.shelf(self.slug);}).then(function(data){var i,len,ref,spec;if(utils.isArray(data.shelf.spec,true)){ref=data.shelf.spec;for(i=0,len=ref.length;i<len;i++){spec=ref[i];self.sel_attrs[spec.key]=null;}
data.shelf.spec=self._organize_spec(data.shelf.spec,data.sku_list);}
return self.setData({loaded:true,shelf:data.shelf,sku_list:data.sku_list,sku_status:self._check_sku_status(data.sku_list),discounts:data.discounts});});},goto_cart:function(){return app.nav.tab({route:core.config.paths.cart});},open_sheet:function(e){var self;self=this;return self.setData({action_type:e.currentTarget.dataset.actionType,sel_sku:self._find_selected_sku(),sheet_status:true});},select_spec:function(e){var curr_opt_idx,curr_spec,i,j,len,len1,opt,ref,self,shelf_spec,spec,spec_key;self=this;spec_key=e.currentTarget.dataset.specKey;curr_opt_idx=e.currentTarget.dataset.optIndex;curr_spec=false;shelf_spec=self.data.shelf.spec;for(i=0,len=shelf_spec.length;i<len;i++){spec=shelf_spec[i];if(spec.key===spec_key){curr_spec=spec;ref=spec.options;for(j=0,len1=ref.length;j<len1;j++){opt=ref[j];delete opt.selected;}}}
if(!curr_spec){return;}
curr_spec.options[curr_opt_idx].selected=true;self.sel_attrs[curr_spec.key]=curr_spec.options[curr_opt_idx].value;self.data.shelf.spec=self._organize_spec(shelf_spec,self.data.sku_list);return self.setData({sel_sku:self._find_selected_sku(),shelf:self.data.shelf});},increase_amount:function(){var amount,self;self=this;amount=Math.max(self.data.amount+=1,1);return self.setData({amount:amount});},decrease_amount:function(){var amount,self;self=this;amount=Math.max(self.data.amount-=1,1);return self.setData({amount:amount});},buy:function(e){var action_type,cart_item,old_cart_item,self,sku;self=this;action_type=e.currentTarget.dataset.actionType;self.setData({action_type:null,sheet_status:false});sku=self.data.sel_sku;if(!sku){return;}
cart_item={id:sku.id,item_id:sku.commodity_id,name:sku.name,figure:self._get_sku_figure_src(sku),detail:sku.detail,attrs:sku.attrs,signature:sku.signature,price:sku.dis_price>=0?sku.dis_price:sku.price,amount:self.data.amount,discounts:self._get_discount_tagnames()};if(action_type==='purchase'){app.checkout.sync([cart_item]);return app.nav.go({route:core.config.paths.purchase,args:{direct:true}});}else{old_cart_item=app.cart.get(cart_item.id);if(old_cart_item&&old_cart_item.signature===cart_item.signature){cart_item.amount+=old_cart_item.amount;app.cart.update(cart_item);}else{app.cart.add(cart_item);}
return self.setData({count_cart_items:app.cart.list().length});}},_check_sku_status:function(sku_list){var count_qty;if(!sku_list||sku_list.length<=0){return 0;}
count_qty=sku_list.reduce(function(x,y){return x+y.qty;},0);if(count_qty>0){return 1;}else{return 2;}},_organize_spec:function(shelf_spec,sku_list){var __check_opt_in_skus,_tmp_list,i,j,l,len,len1,len2,len3,m,op,opt,ref,ref1,s,sel_op,self,sku,spec,stock_list;self=this;__check_opt_in_skus=function(k,v,skus){var i,len,sku;for(i=0,len=skus.length;i<len;i++){sku=skus[i];if(sku.attrs[k]===v){return true;}}
return false;};stock_list=(function(){var i,len,results;results=[];for(i=0,len=sku_list.length;i<len;i++){sku=sku_list[i];if(sku.qty){results.push(sku);}}
return results;})();for(i=0,len=shelf_spec.length;i<len;i++){spec=shelf_spec[i];_tmp_list=stock_list;for(j=0,len1=shelf_spec.length;j<len1;j++){s=shelf_spec[j];if(s.key===spec.key){continue;}
sel_op={};ref=s.options;for(l=0,len2=ref.length;l<len2;l++){op=ref[l];if(op.selected){sel_op=op;break;}}
if(sel_op.value){_tmp_list=(function(){var len3,m,results;results=[];for(m=0,len3=_tmp_list.length;m<len3;m++){sku=_tmp_list[m];if(sku.attrs[s.key]===sel_op.value&&sku.qty){results.push(sku);}}
return results;})();}}
ref1=spec.options;for(m=0,len3=ref1.length;m<len3;m++){opt=ref1[m];if(__check_opt_in_skus(spec.key,opt.value,_tmp_list)){opt.disabled=false;}else{opt.disabled=true;}}}
return shelf_spec;},_find_selected_sku:function(){var __match_attrs,i,k,len,ref,ref1,self,sku,v;self=this;if(!self.data.shelf.is_various){if(self.data.sku_list[0]&&self.data.sku_list[0].qty){return self.data.sku_list[0];}else{return null;}}
ref=self.sel_attrs;for(k in ref){v=ref[k];if(!v){return null;}}
__match_attrs=function(sku){var ref1;ref1=self.sel_attrs;for(k in ref1){v=ref1[k];if(sku.attrs[k]!==v){return false;}}
return true;};ref1=self.data.sku_list;for(i=0,len=ref1.length;i<len;i++){sku=ref1[i];if(__match_attrs(sku)){return sku;}}
return null;},_get_sku_figure_src:function(sku){var i,j,len,len1,opt,ref,ref1,self,spec;self=this;if(!self.data.shelf||!utils.isArray(self.data.shelf.spec)){return'';}
ref=self.data.shelf.spec;for(i=0,len=ref.length;i<len;i++){spec=ref[i];ref1=spec.options;for(j=0,len1=ref1.length;j<len1;j++){opt=ref1[j];if(sku.attrs[spec.key]===opt.value&&opt.src){return opt.src;}}}},_get_discount_tagnames:function(){var discount,e,self;self=this;try{return(function(){var i,len,ref,results;ref=self.data.discounts;results=[];for(i=0,len=ref.length;i<len;i++){discount=ref[i];results.push(discount.tagname);}
return results;})();}catch(error){e=error;return null;}}});}).call(this);