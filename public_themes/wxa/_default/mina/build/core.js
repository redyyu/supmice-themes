// Generated by CoffeeScript 2.0.2
(function() {
  var PageEnhanced, Session, _validation, _validator, authorize_run, config, dialog, form_validator, image, reform_consignee, reform_userinfo, requests, session, static_title, utils;

  requests = require('libs/requests.js');

  Session = require('libs/session.js');

  config = require('config.js');

  utils = require('utils.js');

  image = require('constant/image.js');

  static_title = require('constant/static_title.js');

  // session
  session = new Session();

  // enhanced page
  PageEnhanced = function(opts) {
    var onLoadFn, onShowFn, self;
    self = this;
    if (!opts) {
      opts = {};
    }
    onLoadFn = opts.onLoad || function(opts) {};
    onShowFn = opts.onShow || function() {};
    opts.onLoad = function(opts) {
      self = this;
      return onLoadFn.call(self, opts);
    };
    opts.onShow = function() {
      var app;
      self = this;
      app = getApp();
      self.setData({
        store: app.store
      });
      return onShowFn.call(self);
    };
    return Page(opts);
  };

  // interceptor
  requests.config.common.interceptor = function(opts) {
    var token;
    if (!opts.url.match(/^http[s]:.*/)) {
      opts.url = config.baseURL.api + '/' + utils.strip(opts.url, '/');
    }
    opts.after_reject = function(res) {
      var to_url;
      switch (res.statusCode) {
        case 401:
          to_url = config.paths.error;
          return session.remove('token');
        case 403:
          to_url = config.paths.error;
          return session.remove('token');
        default:
          return wx.redirectTo({
            url: config.paths.error
          });
      }
    };
    opts.header = opts.header || {};
    token = session.get('token');
    if (token && !opts.header.Authorization) {
      opts.header = {
        Authorization: 'Bearer ' + token
      };
    }
    return opts;
  };

  // authorize before run
  authorize_run = function(opts, callback, fail_callback) {
    if (!opts) {
      opts = {};
    }
    if (!utils.isFunction(callback)) {
      callback = function() {};
    }
    if (!utils.isFunction(fail_callback)) {
      fail_callback = function() {};
    }
    return wx.getSetting({
      success: function(data) {
        if (data.authSetting[opts.scope]) {
          return callback(data);
        } else if (opts.required) {
          if (data.authSetting[opts.scope] === void 0) {
            return callback(data);
          } else if (data.authSetting[opts.scope] === false) {
            return wx.openSetting({
              success: function(op_data) {
                if (op_data.authSetting[opts.scope]) {
                  return callback(data);
                }
              },
              fail: function(error) {
                return fail_callback(error);
              }
            });
          }
        }
      },
      fail: function(error) {
        return fail_callback(error);
      }
    });
  };

  // form validator
  _validator = {
    required: function(value) {
      return /.+/i.test(value.replace(' ', ''));
    }
  };

  _validation = function(rules, value) {
    var i, len, rule;
    if (utils.isString(rules)) {
      rules = [rules];
    } else if (!utils.isArray(rules)) {
      return null;
    }
    for (i = 0, len = rules.length; i < len; i++) {
      rule = rules[i];
      try {
        if (_validator[rule] && !_validator[rule](value)) {
          return false;
        }
      } catch (error1) {
        return false;
      }
    }
    return true;
  };

  form_validator = {
    validate: function(from_value, rules) {
      var ffv, k, v;
      if (!utils.isDict(rules, true)) {
        return;
      }
      ffv = {};
      for (k in from_value) {
        v = from_value[k];
        ffv[k] = _validation(rules[k], v);
      }
      for (k in ffv) {
        v = ffv[k];
        if (v === false) {
          ffv.$error = true;
        }
      }
      return ffv;
    },
    setPristine: function(ffv, field_name) {
      var e, k, v;
      try {
        delete ffv[field_name];
      } catch (error1) {
        e = error1;
        console.error(e);
      }
      for (k in ffv) {
        v = ffv[k];
        if (v === false) {
          ffv.$error = true;
        }
      }
      return ffv;
    }
  };

  reform_consignee = function(info) {
    var payload;
    payload = {
      name: info.userName,
      detail: info.detailInfo,
      tel: info.telNumber,
      province: info.provinceName,
      city: info.cityName,
      county: info.countyName,
      postal_code: info.postalCode,
      recipient: [info.userName, info.telNumber, info.provinceName, info.cityName, info.countyName, info.detailInfo, '[' + info.postalCode + ']'].join(' ')
    };
    return payload;
  };

  reform_userinfo = function(userinfo) {
    var _gender_map, info;
    if (!userinfo) {
      userinfo = {};
    }
    _gender_map = {
      1: 1, // male
      2: 0, // female
      0: 2 // unknow
    };
    info = {
      country: userinfo.country || '',
      province: userinfo.province || '',
      city: userinfo.city || '',
      language: userinfo.language || 'zh_CN',
      name: userinfo.nickName || '',
      avatar: userinfo.avatarUrl || '',
      gender: _gender_map[userinfo.gender] || 0
    };
    return info;
  };

  // model
  dialog = {
    confirm: function(opts) {
      var modal_opts;
      if (!opts) {
        opts = {};
      }
      if (!utils.isFunction(opts.confirm)) {
        opts.confirm = function() {};
      }
      if (!utils.isFunction(opts.cancel)) {
        opts.cancel = function() {};
      }
      modal_opts = {
        title: opts.title || '',
        content: opts.content || '',
        success: function(result) {
          if (result.confirm) {
            return opts.confirm();
          } else {
            return opts.cancel(result.cancel);
          }
        },
        fail: function() {
          return opts.cancel(null);
        }
      };
      if (opts.confirmColor) {
        modal_opts.confirmColor = opts.confirmColor;
      }
      if (opts.confirmText) {
        modal_opts.confirmText = opts.confirmText;
      }
      if (opts.cancelColor) {
        modal_opts.cancelColor = opts.cancelColor;
      }
      if (opts.cancelText) {
        modal_opts.cancelText = opts.cancelText;
      }
      return wx.showModal(modal_opts);
    },
    alert: function(opts) {
      var modal_opts;
      if (!opts) {
        opts = {};
      }
      if (!utils.isFunction(opts.confirm)) {
        opts.confirm = function() {};
      }
      modal_opts = {
        title: opts.title || '',
        content: opts.content || '',
        showCancel: false,
        success: function(result) {
          if (result.confirm) {
            return opts.confirm();
          }
        }
      };
      if (opts.confirmColor) {
        modal_opts.confirmColor = opts.confirmColor;
      }
      if (opts.confirmText) {
        modal_opts.confirmText = opts.confirmText;
      }
      return wx.showModal(modal_opts);
    }
  };

  module.exports = {
    Page: PageEnhanced,
    config: config,
    session: session,
    image: image,
    static_title: static_title,
    authorize_run: authorize_run,
    form_validator: form_validator,
    reform_consignee: reform_consignee,
    reform_userinfo: reform_userinfo,
    dialog: dialog
  };

}).call(this);
