// Generated by CoffeeScript 2.0.2
(function() {
  var app, core, restStore, utils;

  core = require('../../core.js');

  utils = require('../../utils.js');

  restStore = require('../../restapi/store.js');

  app = getApp();

  core.Page({
    data: {
      image: core.image,
      is_loading: null,
      has_more: null,
      products: [],
      meta: {},
      content: ''
    },
    paged: 1,
    timestamp: null,
    // lifecycle
    onShareAppMessage: function() {
      return app.share();
    },
    onLoad: function() {
      var self;
      self = this;
      return restStore.page.get('index').then(function(page) {
        app.set_navbar(page.meta.title);
        return self.setData({
          meta: page.meta,
          content: page.content
        });
      }).then(function() {
        return self.refresh();
      });
    },
    onPullDownRefresh: function() {
      var self;
      self = this;
      return self.refresh().finally(function() {
        return wx.stopPullDownRefresh();
      });
    },
    onReachBottom: function() {
      var self;
      self = this;
      if (self.data.has_more === true) {
        self.paged += 1;
        return self.list();
      }
    },
    // hanlders
    refresh: function() {
      var self;
      self = this;
      self.paged = 1;
      self.timestamp = utils.now();
      self.setData({
        products: [],
        has_more: null
      });
      return self.list();
    },
    list: function() {
      var self;
      self = this;
      self.setData({
        is_loading: true
      });
      return restStore.product.list({
        paged: self.paged,
        t: self.timestamp
      }).then(function(results) {
        return self.setData({
          products: self.data.products.concat(results),
          has_more: results[0] && results[0]._more
        });
      }).finally(function() {
        return self.setData({
          is_loading: false
        });
      });
    },
    enter: function(e) {
      var item, self;
      self = this;
      item = e.currentTarget.dataset.item;
      if (!item) {
        return;
      }
      return app.nav.go({
        route: core.config.paths.item,
        args: {
          slug: item.slug
        }
      });
    }
  });

}).call(this);
