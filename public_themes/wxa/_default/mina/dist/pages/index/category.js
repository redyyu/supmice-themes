(function(){var e,t,a,r;t=require("../../core.js");r=require("../../utils.js");a=require("../../restapi/store.js");e=getApp();Page({data:{image:t.image,is_loading:null,has_more:null,commodities:[],category:null},paged:1,perpage:12,last_paged:1,timestamp:r.now(),extra_query:false,onShareAppMessage:function(){var t;t=this;return e.share(t.data.category)},onLoad:function(e){var t;t=this;return a.category.get(e.slug).then(function(e){return t.setData({category:e})}).then(function(){return t.list_cat()})},onPullDownRefresh:function(){var e;e=this;e.paged=1;e.last_paged=1;e.timestamp=r.now();e.extra_query=false;e.setData({commodities:[],has_more:null});return e.list_cat().finally(function(){return wx.stopPullDownRefresh()})},onReachBottom:function(){var e;e=this;if(e.data.has_more===true){return e.load_more()}},list_cat:function(){var e;e=this;return e._query_items()},load_more:function(){var e;e=this;e.paged+=1;if(!e.extra_query){return e._query_items()}else{return e._query_extra()}},enter:function(t){return e.enter_item(t.currentTarget.dataset.item)},_query_items:function(){var t;t=this;t.setData({is_loading:true});return a.commodity.list({data:{categories:t.data.category.cat_ids,paged:t.paged,perpage:t.perpage,timestamp:t.timestamp}}).then(function(a){var r,n,o;for(r=0,o=a.length;r<o;r++){n=a[r];n.coupon=e.parse_coupon(n.coupon_info)}if(!a.length||!a[0]._more){t.extra_query=true;t.last_paged=t.paged}if(a.length){t.setData({has_more:true,commodities:t.data.commodities.concat(a)})}if(t.paged===1&&t.extra_query){return t.load_more()}}).finally(function(){return t.setData({is_loading:false})})},_query_extra:function(){var t;t=this;t.setData({is_loading:true});return a.coupon.list({data:{categories:t.data.category.cat_ids,paged:t.paged-t.last_paged,perpage:t.perpage}}).then(function(a){var r,n,o;for(r=0,o=a.length;r<o;r++){n=a[r];n.coupon=e.parse_coupon(n.coupon_info)}return t.setData({commodities:t.data.commodities.concat(a),has_more:a.length>=t.perpage})}).finally(function(){return t.setData({is_loading:false})})}})}).call(this);
