(function(){var t,o,e,n;o=require("../../core.js");n=require("../../utils.js");e=require("../../restapi/store.js");t=getApp();Page({data:{image:o.image,is_loading:null,has_more:null,commodities:[],promotion:null},paged:1,perpage:12,timestamp:n.now(),onShareAppMessage:function(){var o;o=this;return t.share(o.data.promotion)},onLoad:function(t){var o;o=this;return e.promotion.get(t.slug).then(function(t){return o.setData({promotion:t})}).then(function(){return o.list_promo()})},onPullDownRefresh:function(){var t;t=this;t.paged=1;t.timestamp=n.now();t.setData({commodities:[],has_more:null});return t.list_promo().finally(function(){return wx.stopPullDownRefresh()})},onReachBottom:function(){var t;t=this;if(t.data.has_more===true){t.paged+=1;return t.list_promo()}},list_promo:function(){var o,n;n=this;n.setData({is_loading:true});o=n.data.promotion.slug;return e.promotion.items(o,{data:{paged:n.paged,perpage:n.perpage}}).then(function(o){var e,r,a;for(e=0,a=o.length;e<a;e++){r=o[e];r.coupon=t.parse_coupon(r.coupon_info)}return n.setData({commodities:n.data.commodities.concat(o),has_more:o[0]&&o[0]._more})}).finally(function(){return n.setData({is_loading:false})})},enter:function(e){var n,r,a;a=this;r=a.data.promotion;n=e.currentTarget.dataset.item;n.share_path=o.config.paths.promotion+"?slug="+r.slug;return t.enter_item(n)}})}).call(this);
