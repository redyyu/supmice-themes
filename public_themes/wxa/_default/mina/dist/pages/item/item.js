(function(){var t,e,n;e=require("../../core.js");n=require("../../restapi/store.js");t=getApp();Page({data:{image:e.image,item:null,details:null},id:null,submitted:false,onShareAppMessage:function(){var e;e=this;return t.share(e.data.item)},onLoad:function(e){var n,r;r=this;r.id=e.id;n=t.g.current_item;if(n){r.load_details(n);return r.setData({item:n})}else{return r.load_item()}},onPullDownRefresh:function(){return wx.stopPullDownRefresh()},load_item:function(){var t;t=this;return n.commodity.get(t.id).then(function(e){t.load_details(e);return t.setData({item:e})})},load_details:function(t){var e;e=this;return setTimeout(function(){return n.details.get(t.item_id).then(function(t){return e.setData({details:t})})},600)},buy:function(){var e,r,i;i=this;r=i.data.item;if(!r||!r.url||i.submitted){return}e=t.cart.get(r.id);if(e){return t.show_coupon({code:e.coupon_code,msg:e.coupon_msg})}else{i.submitted=true;return n.coupon.code({data:{text:r.title,url:r.url,logo:r.src,item:r}}).then(function(e){t.cart.add({id:r.id,price:r.price,src:r.src,title:r.title,url:r.url,coupon_info:r.coupon_info,coupon_code:e.code,coupon_msg:e.msg});return t.show_coupon({code:e.code,msg:e.msg})}).catch(function(t){return console.error(t)}).finally(function(){return i.submitted=false})}},try_to_buy:function(t){var n,r;r=this;n=t.currentTarget.dataset;if(!n){return}return e.dialog.confirm({title:n.title,content:n.content,confirmText:n.confirmText,cancelText:n.cancelText,confirm:function(){return r.buy()}})}})}).call(this);
