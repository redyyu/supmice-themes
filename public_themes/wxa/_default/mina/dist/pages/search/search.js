(function(){var e,a,t,r;a=require("../../core.js");r=require("../../utils.js");t=require("../../restapi/store.js");e=getApp();Page({data:{image:a.image,search_key:null,has_more:null,is_loading:null,commodities:[]},paged:1,perpage:12,keyword:null,last_paged:1,timestamp:r.now(),extra_search:false,onShareAppMessage:function(){return e.share()},onLoad:function(e){var a;return a=this},onPullDownRefresh:function(){var e;e=this;e.paged=1;e.last_paged=1;e.timestamp=r.now();e.extra_search=false;e.keyword=null;e.setData({commodities:[],has_more:null});return wx.stopPullDownRefresh()},onReachBottom:function(){var e;e=this;if(e.keyword&&e.data.has_more===true){return e.load_more()}},search:function(e){var a,t;t=this;if(e.type==="submit"){a=e.detail.value.keyword}else if(e.type==="confirm"){a=e.detail.value}else{a=null}if(!a){return}t.paged=1;t.last_paged=1;t.timestamp=r.now();t.extra_search=false;t.keyword=a;t.setData({commodities:[],has_more:null});wx.showLoading({mask:true});return t._search().finally(function(){return wx.hideLoading()})},load_more:function(){var e;e=this;e.paged+=1;if(!e.extra_search){return e._search()}else{return e._search_extra()}},enter:function(a){return e.enter_item(a.currentTarget.dataset.item)},_search:function(){var a,r,n,o;o=this;o.setData({is_loading:true});a=o.keyword.replace(/,|ï¼Œ|;|\s/gi,"&").split("&");n=function(){var e,t,n;n=[];for(e=0,t=a.length;e<t;e++){r=a[e];if(r){n.push(r)}}return n}();return t.commodity.search({data:{paged:o.paged,perpage:o.perpage,keywords:n,timestamp:o.timestamp}}).then(function(a){var t,r,n;for(t=0,n=a.length;t<n;t++){r=a[t];r.coupon=e.parse_coupon(r.coupon_info)}if(!a.length||!a[0]._more){o.extra_search=true;o.last_paged=o.paged}if(a.length){o.setData({has_more:true,commodities:o.data.commodities.concat(a)})}if(o.paged===1&&o.extra_search){return o.load_more()}}).finally(function(){return o.setData({is_loading:false})})},_search_extra:function(){var a;a=this;a.setData({is_loading:true});return t.coupon.search({data:{paged:a.paged-a.last_paged,perpage:a.perpage,keyword:a.keyword}}).then(function(t){var r,n,o;for(r=0,o=t.length;r<o;r++){n=t[r];n.coupon=e.parse_coupon(n.coupon_info)}return a.setData({commodities:a.data.commodities.concat(t),has_more:t.length>=a.perpage})}).finally(function(){return a.setData({is_loading:false})})}})}).call(this);
